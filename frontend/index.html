<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>DataMend</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* Your existing styles stay the same for clean look */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e1e2f, #23233a);
            color: #fff;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 960px;
            margin: 40px auto;
            padding: 40px;
            background-color: rgba(44, 44, 60, 0.95);
            border-radius: 15px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2rem;
            background: linear-gradient(45deg, #4fc3f7, #1a73e8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        label {
            display: block;
            margin-top: 20px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        input,
        select {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border-radius: 8px;
            border: none;
            background-color: #3a3a50;
            color: white;
        }

        .button-row {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        button {
            flex: 1 1 200px;
            padding: 14px;
            font-size: 16px;
            border-radius: 8px;
            background: linear-gradient(135deg, #1a73e8, #4fc3f7);
            color: white;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.25s ease;
        }

        button:hover {
            transform: scale(1.04);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.5);
        }

        #statusMsg {
            margin-top: 20px;
            font-weight: bold;
            color: #66ccff;
        }

        .file-upload-container {
            position: relative;
            margin-top: 10px;
        }

        #uploadButton {
            background: linear-gradient(135deg, #26c6da, #00acc1);
            color: white;
            font-weight: 600;
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
        }

        #uploadButton:hover {
            transform: scale(1.05);
        }

        #fileName {
            margin-left: 12px;
            font-style: italic;
            color: #bbb;
        }

        table {
            width: 100%;
            margin-top: 30px;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 12px;
            border: 1px solid #444;
        }

        th {
            background: linear-gradient(45deg, #3949ab, #1e88e5);
            color: white;
        }

        tr:nth-child(even) {
            background-color: #2f2f45;
        }

        tr:nth-child(odd) {
            background-color: #262636;
        }

        @media screen and (max-width: 768px) {
            .container {
                margin: 20px;
                padding: 20px;
            }

            .button-row {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>DataMend</h1>

        <label for="serverName">SQL Server Name:</label>
        <input type="text" id="serverName" placeholder="tsfarm-sql19\sql2019" />

        <label for="databaseName">Database Name:</label>
        <input type="text" id="databaseName" placeholder="TRSSky2" />

        <label for="dataType">Select Data Type:</label>
        <select id="dataType" required>
            <option value="" disabled selected hidden>-- Select a data type --</option>
        </select>

        <label for="dataFileUpload">Upload File:</label>
        <div class="file-upload-container">
            <input type="file" id="dataFile" style="display: none;" />
            <button type="button" id="uploadButton">üìÅ Choose File</button>
            <span id="fileName">No file chosen</span>
        </div>

        <div class="button-row">
            <button onclick="testConnection()">üîå Test SQL Connection</button>
            <button onclick="getGrowerTable()">üìã View Grower Table</button>
            <button onclick="runValidation()">‚öôÔ∏è Run Full Validation</button>
        </div>

        <p id="statusMsg"></p>
        <div id="tableWrapper" class="table-wrapper"></div>
    </div>

    <script>
        document.getElementById("uploadButton").addEventListener("click", () => {
            document.getElementById("dataFile").click();
        });

        document.getElementById("dataFile").addEventListener("change", () => {
            const fileInput = document.getElementById("dataFile");
            const fileNameDisplay = document.getElementById("fileName");
            if (fileInput.files.length > 0) {
                fileNameDisplay.textContent = fileInput.files[0].name;
            } else {
                fileNameDisplay.textContent = "No file chosen";
            }
        });

        async function testConnection() {
            const server = document.getElementById("serverName").value.trim();
            const database = document.getElementById("databaseName").value.trim();
            const statusMsg = document.getElementById("statusMsg");

            if (!server || !database) {
                statusMsg.innerText = "Please enter both SQL Server and Database names.";
                return;
            }

            const formData = new FormData();
            formData.append("server", server);
            formData.append("database", database);

            statusMsg.innerText = "Testing connection...";

            try {
                const response = await fetch("http://127.0.0.1:5000/test-connection", {
                    method: "POST",
                    body: formData
                });
                const result = await response.json();
                statusMsg.innerText = result.message || result.error;
            } catch (error) {
                console.error(error);
                statusMsg.innerText = "Connection test failed.";
            }
        }

        async function getGrowerTable() {
            const server = document.getElementById("serverName").value.trim();
            const database = document.getElementById("databaseName").value.trim();
            const wrapper = document.getElementById("tableWrapper");
            const statusMsg = document.getElementById("statusMsg");

            wrapper.innerHTML = "";
            statusMsg.innerText = "Loading grower table...";

            const formData = new FormData();
            formData.append("server", server);
            formData.append("database", database);

            try {
                const response = await fetch("http://127.0.0.1:5000/get-growers", {
                    method: "POST",
                    body: formData
                });

                const result = await response.json();

                if (response.ok && result.data) {
                    const table = document.createElement("table");
                    const thead = document.createElement("thead");
                    const headerRow = document.createElement("tr");

                    Object.keys(result.data[0]).forEach(col => {
                        const th = document.createElement("th");
                        th.textContent = col;
                        headerRow.appendChild(th);
                    });

                    thead.appendChild(headerRow);
                    table.appendChild(thead);

                    const tbody = document.createElement("tbody");
                    result.data.forEach(row => {
                        const tr = document.createElement("tr");
                        Object.values(row).forEach(val => {
                            const td = document.createElement("td");
                            td.textContent = val === null ? "" : val;
                            tr.appendChild(td);
                        });
                        tbody.appendChild(tr);
                    });

                    table.appendChild(tbody);
                    wrapper.appendChild(table);
                    statusMsg.innerText = "‚úÖ Grower table loaded.";
                } else {
                    statusMsg.innerText = result.error || "Failed to get grower table.";
                }
            } catch (error) {
                console.error(error);
                statusMsg.innerText = "Error loading table.";
            }
        }

        async function runValidation() {
            const server = document.getElementById("serverName").value.trim();
            const database = document.getElementById("databaseName").value.trim();
            const dataType = document.getElementById("dataType").value;
            const fileInput = document.getElementById("dataFile");
            const statusMsg = document.getElementById("statusMsg");

            if (!server || !database || !dataType || fileInput.files.length === 0) {
                statusMsg.innerText = "‚ùó Please complete all fields and upload a file.";
                return;
            }

            const formData = new FormData();
            formData.append("server", server);
            formData.append("database", database);
            formData.append("dataType", dataType);
            formData.append("file", fileInput.files[0]);

            statusMsg.innerText = "‚è≥ Running validation...";

            try {
                const response = await fetch("http://127.0.0.1:5000/process", {
                    method: "POST",
                    body: formData
                });

                const result = await response.json();
                statusMsg.innerText = result.message || result.error || "‚ùå Unknown error.";

                // ‚úÖ Fix here: use the dynamic download_link provided by backend
                if ((result.file_type === "excel" || result.file_type === "sql") && result.download_link) {
                    const link = document.createElement("a");
                    link.href = `http://127.0.0.1:5000${result.download_link}`;
                    link.download = "";  // Let browser decide based on Content-Disposition
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }

            } catch (error) {
                console.error(error);
                statusMsg.innerText = "‚ùå Validation failed due to a network or server error.";
            }
        }



        window.onload = function () {
            fetch("http://127.0.0.1:5000/get-validation-options")
                .then(response => response.json())
                .then(options => {
                    const dropdown = document.getElementById("dataType");
                    dropdown.innerHTML = '<option value="" disabled selected hidden>-- Select a data type --</option>';
                    options.forEach(option => {
                        const opt = document.createElement("option");
                        opt.value = option;
                        opt.textContent = option;
                        dropdown.appendChild(opt);
                    });
                })
                .catch(error => {
                    console.error("Failed to load validation options:", error);
                });
        };
    </script>
</body>

</html>